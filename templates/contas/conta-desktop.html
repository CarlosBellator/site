{% extends 'base.html' %}
{% load static %}
{% block content %}
  <body class="body">
    {% csrf_token %}
    <header class="header">
      <a href="{% url 'home' %}"><h1>EduVision IA</h1></a>
    </header>
    <main class="profile-config-container">
      <div class="profile-config">
        <a href="#" onclick="openPhotoModal()"><img src="{{ user_profile.foto_perfil.url }}" alt="" id="profile-image" /></a>
      </div>
      <input type="text" id="nome" name="nome" value="{{ name }}" />

      <!-- Modal para upload de foto -->
      <div id="photoModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Alterar Foto de Perfil</h2>
            <span class="close" onclick="closePhotoModal()">&times;</span>
          </div>
          <div class="modal-body">
            <form id="photoForm" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="file-input-container">
                <input type="file" id="photoInput" name="foto_perfil" accept="image/*" required />
                <label for="photoInput" class="file-input-label">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="currentColor" />
                  </svg>Escolher Arquivo
                </label>
              </div>
              <div id="preview-container" style="display: none;">
                <img id="preview-image" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 50%;" />
              </div>

              <!-- Container para mensagens de erro/sucesso -->
              <div id="photo-message-container" class="message-container" style="display: none;">
                <div id="photo-message-content" class="message-content"></div>
              </div>

              <div class="modal-buttons">
                <button type="button" onclick="closePhotoModal()" class="btn-cancel">Cancelar</button>
                <button type="submit" class="btn-save">Salvar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Fim Modal para upload de foto -->
      <!-- Modal para mudar senha -->
      <div id="passwordModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Alterar Senha</h2>
            <span class="close" onclick="closePasswordModal()">&times;</span>
          </div>
          <div class="modal-body">
            <form id="passwordForm" method="POST" action="{% url 'alterar_senha' %}">
              {% csrf_token %}
              <div class="form-group">
                <label for="senha_atual">Senha atual:</label>
                <input type="password" name="senha_atual" id="senha_atual" placeholder="Senha Atual" required />
              </div>
              <div class="form-group">
                <label for="nova_senha">Nova senha:</label>
                <input type="password" name="nova_senha" id="nova_senha" placeholder="Nova Senha" required />
              </div>
              <div class="form-group">
                <label for="confirmar_senha">Confirmar nova senha:</label>
                <input type="password" name="confirmar_senha" id="confirmar_senha" placeholder="Confirmar Nova Senha" required />
              </div>
              <!-- Container para mensagens de erro/sucesso -->
              <div id="password-message-container" class="message-container" style="display: none;">
                <div id="password-message-content" class="message-content"></div>
              </div>

              <div class="modal-buttons">
                <button type="button" onclick="closePasswordModal()" class="btn-cancel">Cancelar</button>
                <button type="submit" class="btn-save">Alterar Senha</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="config-buttons">
        <a onclick="openPasswordModal()">
          <button id="senha-btn">
            <svg width="56" height="52" viewBox="0 0 56 52" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16.3333 23.8333V15.1666C16.3333 12.2935 17.5625 9.53797 19.7504 7.50632C21.9383 5.47468 24.9058 4.33331 28 4.33331C31.0942 4.33331 34.0617 5.47468 36.2496 7.50632C38.4375 9.53797 39.6667 12.2935 39.6667 15.1666V23.8333M11.6667 23.8333H44.3333C46.9107 23.8333 49 25.7734 49 28.1666V43.3333C49 45.7265 46.9107 47.6666 44.3333 47.6666H11.6667C9.08934 47.6666 7 45.7265 7 43.3333V28.1666C7 25.7734 9.08934 23.8333 11.6667 23.8333Z" stroke="#B2DAFA" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
            </svg>Alterar Senha
          </button>
        </a>
        <a href="{% url 'logout' %}">
          <button id="logout-btn">
            <svg width="56" height="51" viewBox="0 0 56 51" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 44.625H11.6667C10.429 44.625 9.242 44.1772 8.36683 43.3802C7.49167 42.5832 7 41.5022 7 40.375V10.625C7 9.49783 7.49167 8.41683 8.36683 7.6198C9.242 6.82277 10.429 6.375 11.6667 6.375H21M37.3333 36.125L49 25.5M49 25.5L37.3333 14.875M49 25.5H21" stroke="#B2DAFA" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
            </svg>Sair
          </button>
        </a>
      </div>
      <script>
        // Função para atualizar nome
        document.getElementById('nome').addEventListener('input', function () {
          const novoNome = this.value
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value
          fetch('{% url "atualizar_nome" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
              nome: novoNome
            })
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log('Nome atualizado com sucesso')
              }
            })
            .catch((error) => console.error('Erro:', error))
        })
        
        // Funções para controlar o modal de foto
        function openPhotoModal() {
          document.getElementById('photoModal').style.display = 'block'
          document.body.style.overflow = 'hidden' // Previne scroll da página
        }
        
        function closePhotoModal() {
          document.getElementById('photoModal').style.display = 'none'
          document.body.style.overflow = 'auto' // Restaura scroll da página
          // Limpa o preview e mensagens
          document.getElementById('preview-container').style.display = 'none'
          document.getElementById('photoInput').value = ''
          hideMessage()
        }
        
        // Função para mostrar mensagens no modal
        function showPhotoMessage(message, type = 'error') {
          const messageContainer = document.getElementById('photo-message-container')
          const messageContent = document.getElementById('photo-message-content')

          messageContent.textContent = message
          messageContainer.className = `alert alert-slim alert-${type}`
          messageContainer.style.display = 'block'
        
          // Auto-esconder mensagem de sucesso após 3 segundos
          if (type === 'success') {
            messageContainer.className = `alert alert-slim alert-${type}`
            setTimeout(() => {
              hideMessage()
            }, 3000)
          }
        }
        
        // Função para esconder mensagens
        function hideMessage() {
          document.getElementById('message-container').style.display = 'none'
        }
        
        // Fechar modal clicando fora dele
        window.onclick = function (event) {
          const modal = document.getElementById('photoModal')
          if (event.target === modal) {
            closePhotoModal()
          }
        }
        
        // Preview da imagem selecionada
        document.getElementById('photoInput').addEventListener('change', function (event) {
          const file = event.target.files[0]
          if (file) {
            // Limpar mensagens anteriores
            hideMessage()
        
            // Verificar se é uma imagem
            if (!file.type.startsWith('image/')) {
              showPhotoMessage('Por favor, selecione apenas arquivos de imagem.', 'error')
              this.value = ''
              return
            }
        
            // Verificar tamanho do arquivo (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
              showPhotoMessage('O arquivo deve ter no máximo 5MB.', 'error')
              this.value = ''
              return
            }
        
            const reader = new FileReader()
            reader.onload = function (e) {
              document.getElementById('preview-image').src = e.target.result
              document.getElementById('preview-container').style.display = 'block'
            }
            reader.readAsDataURL(file)
          }
        })
        
        // Enviar formulário de foto
        document.getElementById('photoForm').addEventListener('submit', function (e) {
          e.preventDefault()
        
          const fileInput = document.getElementById('photoInput')
          const file = fileInput.files[0]
        
          if (!file) {
            showPhotoMessage('Por favor, selecione uma imagem.', 'error')
            return
          }
        
          const formData = new FormData()
          formData.append('foto_perfil', file)
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value)
        
          // Desabilitar botão de envio
          const submitBtn = document.querySelector('.btn-save')
          submitBtn.disabled = true
          submitBtn.textContent = 'Enviando...'
        
          fetch('{% url "upload_foto_perfil" %}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
          })
            .then((response) => {
              console.log('Status da resposta:', response.status)
              console.log('Content-Type:', response.headers.get('content-type'))
        
              if (!response.ok) {
                return response.text().then((text) => {
                  console.error('Resposta de erro:', text)
                  throw new Error(`HTTP error! status: ${response.status}, response: ${text}`)
                })
              }
        
              const contentType = response.headers.get('content-type')
              if (!contentType || !contentType.includes('application/json')) {
                return response.text().then((text) => {
                  console.error('Resposta não é JSON:', text)
                  throw new Error('Resposta não é JSON válido')
                })
              }
        
              return response.json()
            })
            .then((data) => {
              console.log('Dados recebidos:', data)
              if (data.success) {
                // Atualizar a imagem de perfil na página
                document.getElementById('profile-image').src = data.new_image_url + '?' + new Date().getTime()
                showPhotoMessage('Foto de perfil atualizada com sucesso!', 'success')
                setTimeout(() => {
                  closePhotoModal()
                }, 1500)
              } else {
                showPhotoMessage('Erro ao atualizar foto: ' + (data.message || 'Erro desconhecido'), 'error')
              }
            })
            .catch((error) => {
              console.error('Erro completo:', error)
              showPhotoMessage('Erro ao enviar a foto. Tente novamente.', 'error')
            })
            .finally(() => {
              // Reabilitar botão
              submitBtn.disabled = false
              submitBtn.textContent = 'Salvar'
            })
        })

        // Funções para controlar o modal de senha
        function openPasswordModal() {
          document.getElementById('passwordModal').style.display = 'block'
          document.body.style.overflow = 'hidden' // Previne scroll da página
        }

        function closePasswordModal() {
          document.getElementById('passwordModal').style.display = 'none'
          document.body.style.overflow = 'auto' // Restaura scroll da página
          // Limpa os campos de senha e mensagens
          document.getElementById('senha_atual').value = ''
          document.getElementById('nova_senha').value = ''
          document.getElementById('confirmar_senha').value = ''
          hidePasswordMessage()
        }

        // Enviar formulário de redefinição de senha
        document.getElementById('passwordForm').addEventListener('submit', function (e) {
          e.preventDefault()
          const senhaAtual = document.getElementById('senha_atual').value
          const novaSenha = document.getElementById('nova_senha').value
          const confirmarSenha = document.getElementById('confirmar_senha').value

          if (!senhaAtual || !novaSenha || !confirmarSenha) {
            showPasswordMessage('Por favor, preencha todos os campos.', 'error')
            return
          }

          if (novaSenha !== confirmarSenha) {
            showPasswordMessage('As senhas não coincidem.', 'error')
            return
          }

          if (novaSenha.length < 8) {
            showPasswordMessage('A senha deve ter pelo menos 8 caracteres.', 'error')
            return
          }

          const data = {
            senha_atual: senhaAtual,
            nova_senha: novaSenha,
            confirmar_nova_senha: confirmarSenha
          }
        
          // Desabilitar botão de envio
          const submitBtn = document.querySelector('#passwordForm .btn-save')
          submitBtn.disabled = true
          submitBtn.textContent = 'Alterando...'

          fetch('{% url "alterar_senha" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
          })
            .then((response) => {
              console.log('Status da resposta:', response.status)
        
              if (!response.ok) {
                return response.text().then((text) => {
                  console.error('Resposta de erro:', text)
                  throw new Error(`HTTP error! status: ${response.status}`)
                })
              }
        
              return response.json()
            })
            .then((data) => {
              console.log('Dados recebidos:', data)
              if (data.success) {
                showPasswordMessage('Senha alterada com sucesso!', 'success')
                setTimeout(() => {
                  closePasswordModal()
                  // Opcional: recarregar a página para garantir que a sessão seja atualizada
                  window.location.reload()
                }, 1500)
              } else {
                showPasswordMessage(data.message || 'Erro ao alterar senha.', 'error')
              }
            })
            .catch((error) => {
              console.error('Erro completo:', error)
              showPasswordMessage('Erro ao alterar senha. Tente novamente.', 'error')
            })
            .finally(() => {
              // Reabilitar botão
              submitBtn.disabled = false
              submitBtn.textContent = 'Alterar Senha'
            })
        })
        // Função para mostrar mensagens no modal
        function showPasswordMessage(message, type = 'error') {
          const messageContainer = document.getElementById('password-message-container')
          const messageContent = document.getElementById('password-message-content')

          messageContent.textContent = message
          
          // Remove classes existentes e adiciona as novas
          messageContainer.className = 'message-container'
          if (type === 'success') {
            messageContainer.classList.add('alert', 'alert-slim', 'alert-success')
          } else {
            messageContainer.classList.add('alert', 'alert-slim', 'alert-error')
          }
          
          messageContainer.style.display = 'block'
        
          // Auto-esconder mensagem de sucesso após 3 segundos
          if (type === 'success') {
            setTimeout(() => {
              hidePasswordMessage()
            }, 3000)
          }
        }
        
        // Função para esconder mensagens
        function hideMessage() {
          document.getElementById('message-container').style.display = 'none'
        }

        // Função para esconder mensagens de senha
        function hidePasswordMessage() {
          document.getElementById('password-message-container').style.display = 'none'
        }
        
        // Fechar modal clicando fora dele
        window.onclick = function (event) {
          const modal = document.getElementById('passwordModal')
          if (event.target === modal) {
            closePasswordModal()
          }
        }
      </script>
    </main>
  </body>
{% endblock %}
