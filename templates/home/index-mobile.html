{% extends 'base.html' %}
{% load static %}
{% block content %}
{% csrf_token %}
<body class="body-mobile">
    <header class="header-mobile">
        <a href="{% url 'conta' %}">
            <div class="profile-icon-mobile"> <img src="{{ user_profile.foto_perfil.url }}" alt=""></div>
        </a>
        <h1>EduVision IA</h1>
    </header>
    <div class="processing-progress">
    </div>
    <!-- Modal de selção de gráfico-->
    <div class="graphs-preview-modal" id="graphs-preview-modal">
        <div class="modal-content">
            <div class="modal-header">Seleciona o gráfico desejado
                <span class="close-button" onclick="closeGraphsPreviewModal()">&times;</span>
            </div>
            <div class="graphs-preview">
                <!-- As imagens dos gráficos serão inseridas aqui -->
            </div>
        </div>
    </div>
    <!-- Modal de exibição de gráfico-->
    <div class="graph-display-modal-mobile" id="graph-display-modal">
        <div class="modal-content-mobile">
            <div class="modal-header">Gráfico Selecionado
                <span class="close-button" onclick="closeGraphDisplayModal()">&times;</span>
            </div>
            <div class="graph-display">
                <!-- O gráfico será exibido aqui -->
            </div>
            <div class="data-input-section">
                <div class="input-group-container">
                    <div class="input-group">
                        <label for="x-unit">Unidade Eixo X</label>
                        <input type="text" id="x-unit" name="x-unit" placeholder="Ex: t(s)">
                    </div>
                    <div class="input-group">
                        <label for="y-unit">Unidade Eixo Y</label>
                        <input type="text" id="y-unit" name="y-unit" placeholder="Ex: s(m)">
                    </div>
                </div>
                <div class="input-group-container">
                    <div class="input-group">
                        <label for="x-values">Valores Eixo X</label>
                        <input type="text" id="x-values" name="x-values" placeholder="Ex: 0, 1, 2, 3, 4">
                    </div>
                    <div class="input-group">
                        <label for="y-values">Valores Eixo Y</label>
                        <input type="text" id="y-values" name="y-values" placeholder="Ex: 3, 3, 3, 2, 1">
                    </div>
                </div>

                <div class="button-group">
                    <button class="generate-btn" onclick="openGraphGenerateModal(false)">Gerar</button>
                    <button class="export-btn" onclick="openGraphGenerateModal(true)">Exportar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Input oculto para captura de foto -->
    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
    <!-- Modal de histórico-->
    <section class="history-modal" id="history-modal">
            <div class="modal-content-mobile">
                <div class="modal-header-mobile">
                    <span class="close-mobile" onclick="closeHistoryModal()">&times;</span>
                <h2>Histórico de Gráficos</h2>
             </div>
                <div class="history-items-mobile">
                <!-- Os itens do histórico serão inseridos aqui dinamicamente -->
                 {% for graph in graph_history %}
                    <div class="history-item">
                    <p>{{ graph.name }}</p>
                        <span class="download-icon-mobile" onclick="downloadGraph3D({{ graph.id }})"></span>
                    <img src="{{ graph.imagem.url }}" alt="">
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    <main class="main-container-mobile">
        <aside class="tirar-foto-mobile" onclick="abrirCamera()">
            <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M59.9381 75.9999C68.7746 75.9999 75.9381 68.8365 75.9381 59.9999C75.9381 51.1634 68.7746 43.9999 59.9381 43.9999C51.1015 43.9999 43.9381 51.1634 43.9381 59.9999C43.9381 68.8365 51.1015 75.9999 59.9381 75.9999Z"
                    fill="#B2DAFA" />
                <path
                    d="M45.6517 10L36.5017 20H20.6517C15.1517 20 10.6517 24.5 10.6517 30V90C10.6517 95.5 15.1517 100 20.6517 100H100.652C106.152 100 110.652 95.5 110.652 90V30C110.652 24.5 106.152 20 100.652 20H84.8017L75.6517 10H45.6517ZM60.6517 85C46.8517 85 35.6517 73.8 35.6517 60C35.6517 46.2 46.8517 35 60.6517 35C74.4517 35 85.6517 46.2 85.6517 60C85.6517 73.8 74.4517 85 60.6517 85Z"
                    fill="#B2DAFA" />
            </svg>
        </aside>
        <section class="content-section-mobile">
            <div class="enviar-foto-mobile">
                <svg width="62" height="61" viewBox="0 0 62 61" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M0.904999 0V61H61.905V0H0.904999ZM8.53 7.625H54.28V30.5L46.655 22.875L39.03 30.5L54.28 45.75V53.375H46.655L16.155 22.875L8.53 30.5V7.625Z"
                        fill="#B2DAFA" />
                </svg>
            </div>
            <div class="historico-graficos-mobile" onclick="openHistoryModal()">
                <svg width="61" height="61" viewBox="0 0 61 61" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M0 0V30.5H30.5V0H0ZM38.125 15.25V38.125H15.25V45.75H45.75V15.25H38.125ZM53.375 30.5V53.375H30.5V61H61V30.5H53.375Z"
                        fill="#B2DAFA" />
                </svg>
            </div>
        </section>
    </main>
    <script>
    function uploadFile(file) {
            // Implementação da lógica de upload para o Django
            console.log('Iniciando upload do arquivo:', file);
            const formData = new FormData();
            formData.append('file', file);

            // Adicionar token CSRF
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken.value);
            }

            // Mostrar indicador de processamento
            showProcessingProgress();

            // Fazer upload para o Django
            fetch('/upload/', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    hideProcessingProgress();

                    if (data.success) {
                        console.log('Upload realizado com sucesso:', data);
                        if (data.variaveis) {
                            showSelectedGraph(data.file_path, data);
                        } else if (data.status == 422) {
                            showAlert('Não foi encontrado nenhum gráfico na imagem. Tente outro arquivo ou digite os valores do gráfico.', 'error');
                        } else {
                            const graphsContainer = document.querySelector('.graphs-preview-modal .modal-content .graphs-preview');
                                document.querySelector('.graphs-preview-modal').style.display = 'block';
                                graphsContainer.innerHTML = ''; // Limpar conteúdo anterior
                            imagesHtml = '';
                            for (let i = 0; i < data.graphs_list.length; i++) {
                                imagesHtml += `<img src="${data.graphs_list[i]}" alt="Preview" id="${data.file_name[i]}" onclick="processGraph('${data.graphs_list[i]}')">`;
                            }
                            graphsContainer.innerHTML = `${imagesHtml} `;
                        }

                    } else {
                        console.error('Erro no upload:', data.error);
                        showAlert(data.error);
                    }
                })
                .catch(error => {
                    hideProcessingProgress();
                    console.error('Erro no upload:', error);
                    showAlert('Erro ao enviar arquivo. Tente novamente.'); 
                });
        }
        
        window.showProcessingProgress = function() {
            // Adicionar indicador de carregamento
            const processingBox = document.querySelector('.processing-progress');
            processingBox.style.display = 'block';
            const progressIndicator = document.createElement('div');
            progressIndicator.className = 'upload-progress';
            progressIndicator.innerHTML = `
            <div class="spinner"></div>
            <p>Processando...</p>
        `;
            processingBox.appendChild(progressIndicator);
        }

        window.hideProcessingProgress = function() {
            const progressIndicator = document.querySelector('.upload-progress');
            if (progressIndicator) {
                progressIndicator.remove();
            }
        }

    window.showAlert = function(message, type) {
        // Remover mensagem anterior se existir
        const existingMessage = document.querySelector('.upload-message');
        if (existingMessage) {
            existingMessage.remove();
        }

        // Criar nova mensagem
        const messageDiv = document.createElement('div');
        messageDiv.className = `upload-message ${type}`;
        messageDiv.textContent = message;

        // Inserir mensagem no início da page
        document.body.insertBefore(messageDiv, document.body.firstChild);

        // Remover mensagem após 5 segundos
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 5000);
    }
    function showSelectedGraph(filePath, data) {
    // Armazenar o caminho da imagem na variável global
    currentGraphImagePath = filePath;
    document.getElementById('graph-display-modal').style.display = 'flex';
    const graphDisplay = document.querySelector('.graph-display-modal-mobile .graph-display');
    graphDisplay.innerHTML = `<img src="${filePath}" alt="Gráfico Selecionado">`;

    document.getElementById('x-unit').value = data.variaveis.x_axis_label_text;
    document.getElementById('y-unit').value = data.variaveis.y_axis_label_text;
    document.getElementById('x-values').value = data.variaveis.x_data;
    document.getElementById('y-values').value = data.variaveis.y_data;
}
function closeGraphDisplayModal(){
    document.getElementById('graph-display-modal').style.display = 'none'
    document.body.style.overflow = 'auto' // Restaura scroll da página
    
    // Limpar os valores dos inputs
    document.getElementById('x-unit').value = '';
    document.getElementById('y-unit').value = '';
    document.getElementById('x-values').value = '';
    document.getElementById('y-values').value = '';
}
    function openHistoryModal(){
        document.getElementById('history-modal').style.display = 'block'
        document.body.style.overflow = 'hidden' // Previne scroll da página
    }
    function closeHistoryModal(){
        document.getElementById('history-modal').style.display = 'none'
        document.body.style.overflow = 'auto' // Restaura scroll da página
    }
    function downloadGraph3D(graphId) {
        // Criar um link temporário para iniciar o download
        const downloadUrl = `/download_graph_3d/${graphId}/`;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Função para abrir a câmera nativa do celular
    function abrirCamera() {
        const cameraInput = document.getElementById('camera-input');
        
        // Abrir o seletor de arquivos/câmera nativo
        cameraInput.click();
    }

    // Event listener para quando uma foto for capturada
    document.addEventListener('DOMContentLoaded', function() {
        const cameraInput = document.getElementById('camera-input');
        
        cameraInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                // Verificar se é uma imagem
                if (!file.type.startsWith('image/')) {
                    showAlert('Por favor, selecione uma imagem válida.', 'error');
                    return;
                }
                
                // Enviar a foto usando a função uploadFile
                uploadFile(file);
                
                // Limpar o input para permitir selecionar a mesma foto novamente
                event.target.value = '';
            }
        });
    });
    </script>
{% endblock %}